#!/bin/sh

set -xe

source /configs/common/vars

echo "rr-run-parts: $(basename $0)"

# enable retroroot repo and disable arch repos (we dont want system updates)
#rm /etc/pacman.conf.pacnew
#mv /etc/pacman.d/mirrorlist.pacnew /etc/pacman.d/mirrorlist
cp /overlays/${RR_PLATFORM}/etc/pacman.conf /etc/pacman.conf

# install retroroot packages
pacman --noconfirm -Syy
# TODO

# cleanup package cache
rm -rf /var/cache/pacman/pkg

# copy common overlay
cp -r /overlays/common/. .

# copy platform overlay
cp -r /overlays/${RR_PLATFORM}/. .

# root passwd
echo "root:${RR_ROOT_PASSWORD}" | chpasswd

# create user and groups
useradd -m ${RR_USERNAME}
for GRP in autologin dialout cdrom spi i2c gpio netdev; do
	groupadd -r --system $GRP
done
for GRP in adm dialout cdrom audio users video games input tty gpio spi i2c netdev; do
  usermod -aG $GRP ${RR_USERNAME}
done
echo "${RR_USERNAME}:${RR_USERNAME}" | chpasswd
echo "
root ALL=(ALL) ALL
${RR_USERNAME} ALL=(ALL) ALL
#includedir /etc/sudoers.d
" > /etc/sudoers

# update locales
locale-gen

# enable services
source /configs/common/services
systemctl enable ${RR_SERVICES}

# systemd-networkd resolv.conf handling
#rm /etc/resolv.conf
#ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf

# install desktop bootloader (mbr for now)
if [ "${RR_PLATFORM}" == "desktop" ]; then
  syslinux-install_update -iam
  # update initramfs including overlay
  mkinitcpio -p linux
fi

# final cleanup
rm -rf /bootstrap
rm -rf /configs
rm -rf /overlays

